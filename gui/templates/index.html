<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumFlow - Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <style type="text/tailwindcss">
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #D1D5DB;
            min-height: 100vh;
        }
        .card {
            background-color: #1F2937;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .input-field {
            background-color: #374151;
            border: 1px solid #4B5563;
            color: #D1D5DB;
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 1rem;
        }
        .input-field:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 2px #1E40AF;
        }
        .button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .button-primary {
            background-color: #3B82F6;
            color: white;
        }
        .button-primary:hover {
            background-color: #2563EB;
        }
        .button-danger {
            background-color: #EF4444;
            color: white;
        }
        .button-danger:hover {
            background-color: #DC2626;
        }
        .material-icons {
            font-size: 24px;
            margin-right: 8px;
        }
        .nav-item {
            transition: background-color 0.2s ease-in-out;
        }
        .nav-item:hover {
            background-color: #374151;
        }
        .nav-item.active {
            background-color: #3B82F6;
            color: white;
        }
    </style>
    <script>
        // Initialize configuration data
        const initialConfig = JSON.parse('{{ .JSON }}');
    </script>
    <script src="/static/js/config.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="bg-[#1F2937] shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <span class="material-icons text-blue-400 mr-2">cloud_sync</span>
                <h1 class="text-2xl font-bold text-white">QuantumFlow</h1>
            </div>
            <button id="logoutButton" class="button button-danger">
                <span class="material-icons">logout</span>
                Logout
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex">
            <!-- Navigation -->
            <nav class="w-64 mr-8">
                <div class="card">
                    <ul class="space-y-2">
                        <li>
                            <a href="#server" class="nav-item flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 rounded-md">
                                <span class="material-icons">dns</span>
                                Server
                            </a>
                        </li>
                        <li>
                            <a href="#load-balancing" class="nav-item flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 rounded-md">
                                <span class="material-icons">balance</span>
                                Load Balancing
                            </a>
                        </li>
                        <li>
                            <a href="#backends" class="nav-item flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 rounded-md">
                                <span class="material-icons">storage</span>
                                Backends
                            </a>
                        </li>
                        <li>
                            <a href="#metrics" class="nav-item flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 rounded-md">
                                <span class="material-icons">analytics</span>
                                Metrics
                            </a>
                        </li>
                        <li>
                            <a href="#logging" class="nav-item flex items-center px-4 py-2 text-gray-300 hover:bg-gray-700 rounded-md">
                                <span class="material-icons">description</span>
                                Logging
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Content Sections -->
            <div class="flex-1 space-y-8">
                <!-- Server Section -->
                <section id="server" class="card">
                    <h2 class="text-xl font-semibold text-white mb-4">Server Configuration</h2>
                    <form id="serverForm" class="space-y-4">
                        <div>
                            <label for="serverPort" class="block text-sm font-medium text-gray-300 mb-1">Port</label>
                            <input type="text" id="serverPort" name="server.port" required class="input-field" value="{{ .Config.Server.Port }}">
                        </div>
                        <div>
                            <label for="serverWorkerCount" class="block text-sm font-medium text-gray-300 mb-1">Worker Count</label>
                            <input type="text" id="serverWorkerCount" name="server.worker_count" required class="input-field" value="{{ .Config.Server.WorkerCount }}">
                        </div>
                        <div>
                            <label for="serverTLSEnabled" class="block text-sm font-medium text-gray-300 mb-1">TLS Enabled</label>
                            <input type="checkbox" id="serverTLSEnabled" name="server.tls.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700" {{ if eq .Config.Server.TLS.Enabled "true" }}checked{{ end }}>
                        </div>
                        <div>
                            <label for="serverTLSCertFile" class="block text-sm font-medium text-gray-300 mb-1">TLS Cert File</label>
                            <input type="text" id="serverTLSCertFile" name="server.tls.cert_file" class="input-field" value="{{ .Config.Server.TLS.CertFile }}">
                        </div>
                        <div>
                            <label for="serverTLSKeyFile" class="block text-sm font-medium text-gray-300 mb-1">TLS Key File</label>
                            <input type="text" id="serverTLSKeyFile" name="server.tls.key_file" class="input-field" value="{{ .Config.Server.TLS.KeyFile }}">
                        </div>
                        <div>
                            <label for="serverTLSMinVersion" class="block text-sm font-medium text-gray-300 mb-1">TLS Min Version</label>
                            <input type="text" id="serverTLSMinVersion" name="server.tls.min_version" class="input-field" value="{{ .Config.Server.TLS.MinVersion }}">
                        </div>
                        <div>
                            <label for="serverTLSCipherSuites" class="block text-sm font-medium text-gray-300 mb-1">TLS Cipher Suites</label>
                            <input type="text" id="serverTLSCipherSuites" name="server.tls.cipher_suites" class="input-field" value="{{ join .Config.Server.TLS.CipherSuites "," }}">
                        </div>
                        <div>
                            <label for="serverTLSClientAuth" class="block text-sm font-medium text-gray-300 mb-1">TLS Client Auth</label>
                            <input type="text" id="serverTLSClientAuth" name="server.tls.client_auth" class="input-field" value="{{ .Config.Server.TLS.ClientAuth }}">
                        </div>
                        <button type="submit" class="button button-primary">
                            <span class="material-icons">save</span>
                            Save
                        </button>
                    </form>
                </section>

                <!-- Load Balancing Section -->
                <section id="load-balancing" class="card hidden">
                    <h2 class="text-xl font-semibold text-white mb-4">Load Balancing Configuration</h2>
                    <form id="loadBalancingForm" class="space-y-4">
                        <div>
                            <label for="lbAlgorithm" class="block text-sm font-medium text-gray-300 mb-1">Strategy</label>
                            <select id="lbAlgorithm" name="server.load_balancing.strategy" class="input-field">
                                <option value="round_robin" {{ if eq .Config.Server.LoadBalancing.Strategy "round_robin" }}selected{{ end }}>Round Robin</option>
                                <option value="least_connections" {{ if eq .Config.Server.LoadBalancing.Strategy "least_connections" }}selected{{ end }}>Least Connections</option>
                                <option value="ip_hash" {{ if eq .Config.Server.LoadBalancing.Strategy "ip_hash" }}selected{{ end }}>IP Hash</option>
                            </select>
                        </div>
                        <div>
                            <label for="ipHashEnabled" class="block text-sm font-medium text-gray-300 mb-1">IP Hash Enabled</label>
                            <input type="checkbox" id="ipHashEnabled" name="server.load_balancing.ip_hash.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700" {{ if eq .Config.Server.LoadBalancing.IPHash.Enabled "true" }}checked{{ end }}>
                        </div>
                        <div>
                            <label for="ipHashHeader" class="block text-sm font-medium text-gray-300 mb-1">IP Hash Header</label>
                            <input type="text" id="ipHashHeader" name="server.load_balancing.ip_hash.header" class="input-field" value="{{ .Config.Server.LoadBalancing.IPHash.Header }}">
                        </div>
                        <div>
                            <label for="ipHashFallbackHeader" class="block text-sm font-medium text-gray-300 mb-1">IP Hash Fallback Header</label>
                            <input type="text" id="ipHashFallbackHeader" name="server.load_balancing.ip_hash.fallback_header" class="input-field" value="{{ .Config.Server.LoadBalancing.IPHash.FallbackHeader }}">
                        </div>
                        <div>
                            <label for="weightedRoundRobinEnabled" class="block text-sm font-medium text-gray-300 mb-1">Weighted Round Robin Enabled</label>
                            <input type="checkbox" id="weightedRoundRobinEnabled" name="server.load_balancing.weighted_round_robin.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700" {{ if eq .Config.Server.LoadBalancing.WeightedRoundRobin.Enabled "true" }}checked{{ end }}>
                        </div>
                        <div>
                            <label for="weightByCapacity" class="block text-sm font-medium text-gray-300 mb-1">Weight By Capacity</label>
                            <input type="checkbox" id="weightByCapacity" name="server.load_balancing.weighted_round_robin.weight_by_capacity" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700" {{ if eq .Config.Server.LoadBalancing.WeightedRoundRobin.WeightByCapacity "true" }}checked{{ end }}>
                        </div>
                        <button type="submit" class="button button-primary">
                            <span class="material-icons">save</span>
                            Save
                        </button>
                    </form>
                </section>

                <!-- Backends Section -->
                <section id="backends" class="card hidden">
                    <h2 class="text-xl font-semibold text-white mb-4">Backends Configuration</h2>
                    <form id="backendForm" class="space-y-4 mb-6">
                        <div>
                            <label for="backendUrl" class="block text-sm font-medium text-gray-300 mb-1">URL</label>
                            <input type="url" id="backendUrl" name="url" required class="input-field" placeholder="http://example.com:8080">
                        </div>
                        <div>
                            <label for="backendWeight" class="block text-sm font-medium text-gray-300 mb-1">Weight</label>
                            <input type="number" id="backendWeight" name="weight" required class="input-field" value="1" min="1">
                        </div>
                        <div>
                            <label for="backendMaxConnections" class="block text-sm font-medium text-gray-300 mb-1">Max Connections</label>
                            <input type="number" id="backendMaxConnections" name="max_connections" required class="input-field" value="100" min="1">
                        </div>
                        <button type="submit" class="button button-primary">
                            <span class="material-icons">add</span>
                            Add Backend
                        </button>
                    </form>

                    <div id="backendsList" class="space-y-4">
                        {{ range .Config.Backends }}
                        <div class="card bg-gray-800 p-4 flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-medium text-white">{{ .URL }}</h3>
                                <p class="text-gray-400">Weight: {{ .Weight }} | Max Connections: {{ .MaxConnections }}</p>
                                <p class="text-sm {{ if .Healthy }}text-green-400{{ else }}text-red-400{{ end }}">
                                    Status: {{ if .Healthy }}Healthy{{ else }}Unhealthy{{ end }}
                                </p>
                            </div>
                            <button onclick="deleteBackend('{{ .URL }}')" class="button button-danger">
                                <span class="material-icons">delete</span>
                                Remove
                            </button>
                        </div>
                        {{ end }}
                    </div>
                </section>

                <!-- Metrics Section -->
                <section id="metrics" class="card hidden">
                    <h2 class="text-xl font-semibold text-white mb-4">Metrics Configuration</h2>
                    <form id="metricsForm" class="space-y-4">
                        <div>
                            <label for="metricsEnabled" class="block text-sm font-medium text-gray-300 mb-1">Enabled</label>
                            <input type="checkbox" id="metricsEnabled" name="metrics.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700" {{ if eq .Config.Metrics.Enabled "true" }}checked{{ end }}>
                        </div>
                        <div>
                            <label for="metricsPort" class="block text-sm font-medium text-gray-300 mb-1">Port</label>
                            <input type="text" id="metricsPort" name="metrics.port" class="input-field" value="{{ .Config.Metrics.Port }}">
                        </div>
                        <div>
                            <label for="metricsPath" class="block text-sm font-medium text-gray-300 mb-1">Path</label>
                            <input type="text" id="metricsPath" name="metrics.path" class="input-field" value="{{ .Config.Metrics.Path }}">
                        </div>
                        <div>
                            <label for="metricsAuthEnabled" class="block text-sm font-medium text-gray-300 mb-1">Auth Enabled</label>
                            <input type="checkbox" id="metricsAuthEnabled" name="metrics.auth.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700" {{ if .Config.Metrics.Auth.Enabled }}checked{{ end }}>
                        </div>
                        <div>
                            <label for="metricsBearerToken" class="block text-sm font-medium text-gray-300 mb-1">Bearer Token</label>
                            <input type="text" id="metricsBearerToken" name="metrics.auth.bearer_token" class="input-field" value="{{ .Config.Metrics.Auth.BearerToken }}">
                        </div>
                        <div>
                            <label for="collectInterval" class="block text-sm font-medium text-gray-300 mb-1">Collect Interval</label>
                            <input type="text" id="collectInterval" name="metrics.collect_interval" class="input-field" value="{{ .Config.Metrics.CollectInterval }}">
                        </div>
                        <div>
                            <label for="retentionPeriod" class="block text-sm font-medium text-gray-300 mb-1">Retention Period</label>
                            <input type="text" id="retentionPeriod" name="metrics.retention_period" class="input-field" value="{{ .Config.Metrics.RetentionPeriod }}">
                        </div>
                        <div>
                            <label for="metricsLabels" class="block text-sm font-medium text-gray-300 mb-1">Labels</label>
                            <input type="text" id="metricsLabels" name="metrics.labels" class="input-field" value="{{ range $k, $v := .Config.Metrics.Labels }}{{ $k }}={{ $v }},{{ end }}">
                        </div>
                        <div>
                            <label for="prometheusEnabled" class="block text-sm font-medium text-gray-300 mb-1">Prometheus Enabled</label>
                            <input type="checkbox" id="prometheusEnabled" name="metrics.prometheus.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700" {{ if eq .Config.Metrics.Prometheus.Enabled "true" }}checked{{ end }}>
                        </div>
                        <div>
                            <label for="prometheusNamespace" class="block text-sm font-medium text-gray-300 mb-1">Prometheus Namespace</label>
                            <input type="text" id="prometheusNamespace" name="metrics.prometheus.namespace" class="input-field" value="{{ .Config.Metrics.Prometheus.Namespace }}">
                        </div>
                        <div>
                            <label for="prometheusSubsystem" class="block text-sm font-medium text-gray-300 mb-1">Prometheus Subsystem</label>
                            <input type="text" id="prometheusSubsystem" name="metrics.prometheus.subsystem" class="input-field" value="{{ .Config.Metrics.Prometheus.Subsystem }}">
                        </div>
                        <div>
                            <label for="prometheusPath" class="block text-sm font-medium text-gray-300 mb-1">Prometheus Path</label>
                            <input type="text" id="prometheusPath" name="metrics.prometheus.path" class="input-field" value="{{ .Config.Metrics.Prometheus.Path }}">
                        </div>
                        <button type="submit" class="button button-primary">
                            <span class="material-icons">save</span>
                            Save
                        </button>
                    </form>
                </section>

                <!-- Logging Section -->
                <section id="logging" class="card hidden">
                    <h2 class="text-xl font-semibold text-white mb-4">Logging Configuration</h2>
                    <form id="loggingForm" class="space-y-4">
                        <div>
                            <label for="loggingEnabled" class="block text-sm font-medium text-gray-300 mb-1">Enabled</label>
                            <input type="checkbox" id="loggingEnabled" name="logging.enabled" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700" {{ if eq .Config.Logging.Enabled "true" }}checked{{ end }}>
                        </div>
                        <div>
                            <label for="loggingLevel" class="block text-sm font-medium text-gray-300 mb-1">Level</label>
                            <input type="text" id="loggingLevel" name="logging.level" class="input-field" value="{{ .Config.Logging.Level }}">
                        </div>
                        <div>
                            <label for="loggingFile" class="block text-sm font-medium text-gray-300 mb-1">File</label>
                            <input type="text" id="loggingFile" name="logging.file" class="input-field" value="{{ .Config.Logging.File }}">
                        </div>
                        <div>
                            <label for="loggingMaxSize" class="block text-sm font-medium text-gray-300 mb-1">Max Size</label>
                            <input type="text" id="loggingMaxSize" name="logging.max_size" class="input-field" value="{{ .Config.Logging.MaxSize }}">
                        </div>
                        <div>
                            <label for="loggingMaxBackups" class="block text-sm font-medium text-gray-300 mb-1">Max Backups</label>
                            <input type="text" id="loggingMaxBackups" name="logging.max_backups" class="input-field" value="{{ .Config.Logging.MaxBackups }}">
                        </div>
                        <div>
                            <label for="loggingMaxAge" class="block text-sm font-medium text-gray-300 mb-1">Max Age</label>
                            <input type="text" id="loggingMaxAge" name="logging.max_age" class="input-field" value="{{ .Config.Logging.MaxAge }}">
                        </div>
                        <div>
                            <label for="loggingCompress" class="block text-sm font-medium text-gray-300 mb-1">Compress</label>
                            <input type="checkbox" id="loggingCompress" name="logging.compress" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-600 rounded bg-gray-700" {{ if eq .Config.Logging.Compress "true" }}checked{{ end }}>
                        </div>
                        <div>
                            <label for="loggingFormat" class="block text-sm font-medium text-gray-300 mb-1">Format</label>
                            <input type="text" id="loggingFormat" name="logging.format" class="input-field" value="{{ .Config.Logging.Format }}">
                        </div>
                        <button type="submit" class="button button-primary">
                            <span class="material-icons">save</span>
                            Save
                        </button>
                    </form>
                </section>
            </div>
        </div>
    </div>

    <script>
        // Handle logout
        document.getElementById('logoutButton').addEventListener('click', async function() {
            try {
                console.log('Initiating logout...');
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });

                console.log('Logout response received:', response.status);
                
                if (response.ok) {
                    console.log('Logout successful, clearing data and redirecting...');
                    // Clear any local storage or session data
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Force clear any cookies
                    document.cookie.split(";").forEach(function(c) { 
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                    });
                    
                    // Redirect to login page
                    window.location.href = '/login';
                } else {
                    const error = await response.text();
                    console.error('Logout failed:', error);
                    alert('Error logging out: ' + error);
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out');
            }
        });

        // Handle navigation and section visibility
        document.addEventListener('DOMContentLoaded', function() {
            // Show the first section by default
            const firstSection = document.querySelector('.nav-item');
            if (firstSection) {
                firstSection.classList.add('active');
                const sectionId = firstSection.getAttribute('href').substring(1);
                document.getElementById(sectionId).classList.remove('hidden');
            }

            // Handle navigation clicks
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all nav items
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Hide all sections
                    document.querySelectorAll('section.card').forEach(section => {
                        section.classList.add('hidden');
                    });
                    
                    // Show the selected section
                    const sectionId = this.getAttribute('href').substring(1);
                    document.getElementById(sectionId).classList.remove('hidden');
                });
            });
        });

        // Handle server form submission
        document.getElementById('serverForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get the current full configuration
            const currentConfig = JSON.parse('{{ .JSON }}');
            
            // Update only the server section
            currentConfig.Server = {
                Port: document.getElementById('serverPort').value,
                WorkerCount: document.getElementById('serverWorkerCount').value,
                TLS: {
                    Enabled: document.getElementById('serverTLSEnabled').checked.toString(),
                    CertFile: document.getElementById('serverTLSCertFile').value,
                    KeyFile: document.getElementById('serverTLSKeyFile').value,
                    MinVersion: document.getElementById('serverTLSMinVersion').value,
                    CipherSuites: document.getElementById('serverTLSCipherSuites').value.split(',').map(s => s.trim()).filter(s => s),
                    ClientAuth: document.getElementById('serverTLSClientAuth').value
                },
                LoadBalancing: currentConfig.Server.LoadBalancing,
                ConnectionPool: currentConfig.Server.ConnectionPool,
                Cache: currentConfig.Server.Cache,
                CircuitBreaker: currentConfig.Server.CircuitBreaker
            };

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(currentConfig)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Server configuration saved successfully');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Error saving server configuration: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving server configuration');
            }
        });

        // Handle load balancing form submission
        document.getElementById('loadBalancingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get the current full configuration
            const currentConfig = JSON.parse('{{ .JSON }}');
            
            // Update only the load balancing section
            currentConfig.Server.LoadBalancing = {
                Strategy: document.getElementById('lbAlgorithm').value,
                IPHash: {
                    Enabled: document.getElementById('ipHashEnabled').checked.toString(),
                    Header: document.getElementById('ipHashHeader').value,
                    FallbackHeader: document.getElementById('ipHashFallbackHeader').value
                },
                WeightedRoundRobin: {
                    Enabled: document.getElementById('weightedRoundRobinEnabled').checked.toString(),
                    WeightByCapacity: document.getElementById('weightByCapacity').checked.toString()
                }
            };

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(currentConfig)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Load balancing configuration saved successfully');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Error saving load balancing configuration: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving load balancing configuration');
            }
        });

        // Handle metrics form submission
        document.getElementById('metricsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get the current full configuration
            const currentConfig = JSON.parse('{{ .JSON }}');
            
            // Update only the metrics section
            currentConfig.Metrics = {
                Enabled: document.getElementById('metricsEnabled').checked.toString(),
                Port: document.getElementById('metricsPort').value,
                Path: document.getElementById('metricsPath').value,
                Auth: {
                    Enabled: document.getElementById('metricsAuthEnabled').checked,
                    BearerToken: document.getElementById('metricsBearerToken').value
                },
                CollectInterval: document.getElementById('collectInterval').value,
                RetentionPeriod: document.getElementById('retentionPeriod').value,
                Labels: currentConfig.Metrics.Labels || {},
                Prometheus: {
                    Enabled: document.getElementById('prometheusEnabled').checked.toString(),
                    Namespace: document.getElementById('prometheusNamespace').value,
                    Subsystem: document.getElementById('prometheusSubsystem').value,
                    Path: document.getElementById('prometheusPath').value
                }
            };

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(currentConfig)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Metrics configuration saved successfully');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Error saving metrics configuration: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving metrics configuration');
            }
        });

        // Handle logging form submission
        document.getElementById('loggingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get the current full configuration
            const currentConfig = JSON.parse('{{ .JSON }}');
            
            // Update only the logging section
            currentConfig.Logging = {
                Enabled: document.getElementById('loggingEnabled').checked.toString(),
                Level: document.getElementById('loggingLevel').value,
                File: document.getElementById('loggingFile').value,
                MaxSize: document.getElementById('loggingMaxSize').value,
                MaxBackups: document.getElementById('loggingMaxBackups').value,
                MaxAge: document.getElementById('loggingMaxAge').value,
                Compress: document.getElementById('loggingCompress').checked.toString(),
                Format: document.getElementById('loggingFormat').value
            };

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(currentConfig)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Logging configuration saved successfully');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Error saving logging configuration: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving logging configuration');
            }
        });

        // Handle backend form submission
        document.getElementById('backendForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                url: document.getElementById('backendUrl').value,
                weight: document.getElementById('backendWeight').value,
                max_connections: document.getElementById('backendMaxConnections').value
            };

            try {
                const response = await fetch('/api/backends', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert('Backend added successfully');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Error adding backend: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error adding backend');
            }
        });

        // Handle backend deletion
        async function deleteBackend(url) {
            if (!confirm('Are you sure you want to remove this backend?')) {
                return;
            }

            try {
                const response = await fetch(`/api/backends?url=${encodeURIComponent(url)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Backend removed successfully');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Error removing backend: ' + error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error removing backend');
            }
        }

        // Load initial configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    
                    // Populate server form
                    if (config.Server) {
                        document.getElementById('serverPort').value = config.Server.Port;
                        document.getElementById('serverWorkerCount').value = config.Server.WorkerCount;
                        document.getElementById('serverTLSEnabled').checked = config.Server.TLS.Enabled === 'true';
                        document.getElementById('serverTLSCertFile').value = config.Server.TLS.CertFile;
                        document.getElementById('serverTLSKeyFile').value = config.Server.TLS.KeyFile;
                        document.getElementById('serverTLSMinVersion').value = config.Server.TLS.MinVersion;
                        document.getElementById('serverTLSCipherSuites').value = Array.isArray(config.Server.TLS.CipherSuites) 
                            ? config.Server.TLS.CipherSuites.join(', ')
                            : config.Server.TLS.CipherSuites;
                        document.getElementById('serverTLSClientAuth').value = config.Server.TLS.ClientAuth;
                    }

                    // Populate load balancing form
                    if (config.Server && config.Server.LoadBalancing) {
                        document.getElementById('lbAlgorithm').value = config.Server.LoadBalancing.Strategy;
                        document.getElementById('ipHashEnabled').checked = config.Server.LoadBalancing.IPHash.Enabled === 'true';
                        document.getElementById('ipHashHeader').value = config.Server.LoadBalancing.IPHash.Header;
                        document.getElementById('ipHashFallbackHeader').value = config.Server.LoadBalancing.IPHash.FallbackHeader;
                        document.getElementById('weightedRoundRobinEnabled').checked = config.Server.LoadBalancing.WeightedRoundRobin.Enabled === 'true';
                        document.getElementById('weightByCapacity').checked = config.Server.LoadBalancing.WeightedRoundRobin.WeightByCapacity === 'true';
                    }

                    // Populate metrics form
                    if (config.Metrics) {
                        document.getElementById('metricsEnabled').checked = config.Metrics.Enabled === 'true';
                        document.getElementById('metricsPort').value = config.Metrics.Port;
                        document.getElementById('metricsPath').value = config.Metrics.Path;
                        document.getElementById('metricsAuthEnabled').checked = config.Metrics.Auth.Enabled;
                        document.getElementById('metricsBearerToken').value = config.Metrics.Auth.BearerToken;
                        document.getElementById('collectInterval').value = config.Metrics.CollectInterval;
                        document.getElementById('retentionPeriod').value = config.Metrics.RetentionPeriod;
                        document.getElementById('prometheusEnabled').checked = config.Metrics.Prometheus.Enabled === 'true';
                        document.getElementById('prometheusNamespace').value = config.Metrics.Prometheus.Namespace;
                        document.getElementById('prometheusSubsystem').value = config.Metrics.Prometheus.Subsystem;
                        document.getElementById('prometheusPath').value = config.Metrics.Prometheus.Path;

                        // Populate labels
                        const labelsContainer = document.getElementById('metricsLabels');
                        labelsContainer.innerHTML = '';
                        if (config.Metrics.Labels) {
                            Object.entries(config.Metrics.Labels).forEach(([key, value]) => {
                                addLabelInput(key, value);
                            });
                        }
                    }

                    // Populate logging form
                    if (config.Logging) {
                        document.getElementById('loggingEnabled').checked = config.Logging.Enabled === 'true';
                        document.getElementById('loggingLevel').value = config.Logging.Level;
                        document.getElementById('loggingFile').value = config.Logging.File;
                        document.getElementById('loggingMaxSize').value = config.Logging.MaxSize;
                        document.getElementById('loggingMaxBackups').value = config.Logging.MaxBackups;
                        document.getElementById('loggingMaxAge').value = config.Logging.MaxAge;
                        document.getElementById('loggingCompress').checked = config.Logging.Compress === 'true';
                        document.getElementById('loggingFormat').value = config.Logging.Format;
                    }
                }
            } catch (error) {
                console.error('Error loading configuration:', error);
            }
        }

        // Helper function to add label inputs
        function addLabelInput(key, value) {
            const labelsContainer = document.getElementById('metricsLabels');
            const labelDiv = document.createElement('div');
            labelDiv.className = 'flex gap-2';
            
            const keyInput = document.createElement('input');
            keyInput.type = 'text';
            keyInput.value = key;
            keyInput.className = 'input-field flex-1';
            keyInput.setAttribute('data-key', key);
            
            const valueInput = document.createElement('input');
            valueInput.type = 'text';
            valueInput.value = value;
            valueInput.className = 'input-field flex-1 label-input';
            valueInput.setAttribute('data-key', key);
            
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'button button-danger';
            removeButton.innerHTML = '<span class="material-icons">delete</span>';
            removeButton.onclick = function() {
                labelDiv.remove();
            };
            
            keyInput.addEventListener('change', function() {
                valueInput.setAttribute('data-key', this.value);
            });
            
            labelDiv.appendChild(keyInput);
            labelDiv.appendChild(valueInput);
            labelDiv.appendChild(removeButton);
            labelsContainer.appendChild(labelDiv);
        }

        // Load configuration when page loads
        document.addEventListener('DOMContentLoaded', loadConfig);
    </script>
</body>
</html> 